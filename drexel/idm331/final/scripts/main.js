import*as THREE from"../../scripts/ThreeJS.js";import{OBJLoader}from"../../scripts/OBJLoader.js";const docQ=document.querySelector.bind(document),docQA=document.querySelectorAll.bind(document),vw=Math.max(document.documentElement.clientWidth||0,window.innerWidth||0),vh=Math.max(document.documentElement.clientHeight||0,window.innerHeight||0),canvas=document.getElementById("canvas"),modal_wrap=docQ("#modal_wrap"),start_btn=docQ("#start_btn"),mute_sfx_btn=docQ("#mute_sfx"),mute_bgm_btn=docQ("#mute_bgm"),free_controls=docQ("#free_controls"),modal_close=docQ("#modal_close"),bulletSpeed_input=docQ("#bulletSpeed"),reloadSpeed_input=docQ("#reloadSpeed"),moveSpeed_input=docQ("#moveSpeed"),rowSpeed_input=docQ("#rowSpeed"),intro_btn=docQ("#intro_btn"),cheats_btn=docQ("#cheats_btn"),keyboard=new THREEx.KeyboardState,scene=new THREE.Scene;scene.background=new THREE.Color(38399);const ambLight=new THREE.AmbientLight(1052688,50);scene.add(ambLight);const camera=new THREE.PerspectiveCamera(45,vw/vh,1,1e3);camera.position.set(0,0,50),camera.rotation.set(0,0,0);const renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0});renderer.setSize(vw,vh),canvas.appendChild(renderer.domElement),renderer.setClearColor(0,0);const newWall=e=>{const t=new THREE.MeshBasicMaterial({color:Number("0x"+e.color),side:THREE.DoubleSide}),o=new THREE.PlaneGeometry(e.width,e.height,1,1),n=new THREE.Mesh(o,t);return n.position.set(e.px||0,e.py||0,e.pz||0),n.rotation.set(e.tx||0,e.ty||0,e.tz||0),n.receiveShadow=!0,scene.add(n),n};let walls=[];const wallCount=9,wallWidth=15,wallHeight=80;for(let e=0;e<9;e++){let t,o;o=0==e?-60:walls[e-1].position.x+15,t=e%2==0?"d84b4b":"ffffff",walls.push(newWall({color:t,width:15,height:80,px:o,pz:-150}))}function newRect(e){const t=new THREE.BoxGeometry(e.width||5,e.height||5,e.depth||10),o=new THREE.MeshBasicMaterial({color:Number("0x"+e.color)||7818498}),n=new THREE.Mesh(t,o);return n.castShadow=!0,n.receiveShadow=!0,n.position.set(e.px||0,e.py||0,e.pz||0),n.rotation.set(e.rx||0,e.ry||0,e.rz||0),scene.add(n),n}const topShelf=newRect({width:135,py:80/6,pz:-145}),btmShelf=newRect({width:135,py:-80/6,pz:-145}),topFrame=newRect({width:135,py:37.5,pz:-145}),btmFrame=newRect({width:135,py:-37.5,pz:-145}),leftFrame=newRect({width:80,px:-65,py:0,pz:-145,rz:Math.PI/2}),rightFrame=newRect({width:80,px:65,py:0,pz:-145,rz:Math.PI/2}),leftBlind=newRect({width:80,height:20,px:-77.5,py:0,pz:-145,rz:Math.PI/2,color:"0095ff"}),rightBlind=newRect({width:80,height:20,px:77.5,py:0,pz:-145,rz:Math.PI/2,color:"0095ff"});let loaderCount=0;function setObjColor(e,t){e.traverse(function(e){e instanceof THREE.Mesh&&e.material.color.setHex(t)})}function getBounds(e){if("Mesh"==e.type){if("SphereGeometry"==e.geometry.type){const t=e.geometry.parameters,o=e.position,n=Number(t.radius.toFixed(2)),r=2*n||null;return{height:r,width:r,depth:r,x:o.x-n,y:o.y-n,z:o.z-n,radius:n}}}else if("Group"==e.type){const t=(new THREE.Box3).setFromObject(e),o=new THREE.Vector3;t.getSize(o);const n=e.position;return{height:o.y,width:o.x,depth:o.z,x:n.x-o.x/2,y:n.y,z:n.z}}}const topShelfHeight=topShelf.position.y+2.5,btmShelfHeight=2.5-topShelf.position.y;let ducks=[];const loaderObj=new OBJLoader;for(let e=0;e<4;e++)loaderObj.load("./assets/ducky.obj",t=>{setObjColor(t,16776960);t.scale.set(4,4,4),t.position.x=35*e-32,t.position.y=btmShelfHeight,t.position.z=-145,ducks[e]=t,scene.add(t)},e=>{const t=Math.round(e.loaded/e.total*100);t>=100?readySet():console.log("Progress: "+t)},e=>{console.error("loaderObj ERROR: ",e)});let bullet,targets=[];for(let e=0;e<4;e++)loaderObj.load("./assets/target.obj",t=>{defaultTargetColor(t);t.scale.set(6,6,6),t.position.x=35*e-50,t.position.y=btmShelfHeight,t.position.z=-145,targets[e]=t,scene.add(t)},e=>{const t=Math.round(e.loaded/e.total*100);t>=100?readySet():console.log("Progress: "+t)},e=>{console.error("loaderObj ERROR: ",e)});function defaultTargetColor(e){setObjColor(e.children[0],16777215),setObjColor(e.children[1],16711680)}function setCamDir(e){const t=new THREE.Vector3(0,0,-1).applyMatrix4(camera.matrixWorld).sub(camera.position).normalize();camera[e]=t}(async()=>{const e=new THREE.SphereGeometry(.5,32,32),t=new THREE.MeshBasicMaterial({color:0});bullet=new THREE.Mesh(e,t),bullet.position.z=-1e3,scene.add(bullet)})();let gunPause=!1,reloadSpeed=750;function shootGun(){gunPause||(gunPause=!0,setCamDir("aimDir"),bullet.position.x=camera.position.x,bullet.position.y=camera.position.y,bullet.position.z=camera.position.z,playSound("gun.mp3"),setTimeout(()=>{gunPause=!1},reloadSpeed))}function readySet(){loaderCount++,8==loaderCount&&(start_btn.innerText="Start",start_btn.disabled=!1,setCamDir("aimDir"),start_btn.addEventListener("click",()=>{start_btn.disabled=!0,start_btn.hidden=!0,modal_wrap.style.backgroundColor="#00000070",toggleModal("close"),modal_wrap.addEventListener("click",()=>{toggleModal("close")}),animate(),playBgm()}))}let keyPause=!1,evenFrame=!0;const animate=()=>{requestAnimationFrame(animate),moveObjects(),evenFrame=!evenFrame,evenFrame&&detectCollision(),!keyPause&&keyboardListener(),renderer.render(scene,camera)};let freeMove=!1,moveSpeed=.25;function keyboardListener(){const e=camera.position,t=camera.rotation,o=e=>keyboard.pressed(e);if(o("space")&&shootGun(),o("w")&&(e.y+=2*moveSpeed),o("a")&&(e.x-=2*moveSpeed),o("s")&&(e.y-=2*moveSpeed),o("d")&&(e.x+=2*moveSpeed),o("left")&&(t.y+=moveSpeed/10),o("right")&&(t.y-=moveSpeed/10),freeMove){if(o("up")){setCamDir("moveDir");for(let t=0;t<moveSpeed;t++)e.x+=camera.moveDir.x,e.y+=camera.moveDir.y,e.z+=camera.moveDir.z}if(o("down")){setCamDir("moveDir");for(let t=0;t<moveSpeed;t++)e.x-=camera.moveDir.x,e.y-=camera.moveDir.y,e.z-=camera.moveDir.z}}}let bulletSpeed=8,rowSpeed=.75;function moveObjects(){for(let e=0;e<bulletSpeed;e++)bullet.position.x+=camera.aimDir.x,bullet.position.y+=camera.aimDir.y,bullet.position.z+=camera.aimDir.z;ducks.forEach(e=>{e.position.x>-70.5?e.position.x-=rowSpeed:e.position.x=70.5}),targets.forEach(e=>{e.position.x>-70.5?e.position.x-=rowSpeed:e.position.x=70.5})}function detectCollision(){const e=getBounds(bullet);for(let t=0;t<ducks.length;t++){const o=getBounds(ducks[t]);o.x<e.x+e.width&&o.x+o.width>e.x&&o.y<e.y+e.height&&o.y+o.height>e.y&&o.z<e.z+e.width&&o.z+o.width>e.z&&o.x<e.x+e.height&&o.x+o.height>e.x&&o.z<e.z+e.width&&o.z+o.width>e.z&&o.y<e.y+e.height&&o.y+o.height>e.y?(updateScore(-1,"quack.mp3"),setObjColor(ducks[t],16711680)):setObjColor(ducks[t],16776960);const n=getBounds(targets[t]);e.x<n.x+n.width&&e.x+e.width>n.x&&e.y<n.y+n.height&&e.y+e.height>n.y&&e.z<n.z+n.width&&e.z+e.width>n.z&&e.x<n.x+n.height&&e.x+e.height>n.x&&e.z<n.z+n.width&&o.z+e.width>n.z&&e.y<n.y+n.height&&e.y+e.height>n.y?(updateScore(1,"ding.mp3"),setObjColor(targets[t].children[1],16777215),setObjColor(targets[t].children[0],16711680)):defaultTargetColor(targets[t])}}let endGameNotice=!1;function endGame(){!endGameNotice&&toggleModal("#modal_endGame"),endGameNotice=!0}let score=0;docQ("#score").innerText="Score: "+score;let scorePause=!1;const updateScore=(e,t)=>{scorePause||(scorePause=!0,score<-6e3&&endGame(),t&&playSound(t),score+=100*e,docQ("#score").innerText="Score: "+score,setTimeout(()=>{scorePause=!1},reloadSpeed-100))};let mute_sfx=!1,mute_bgm=!1;const storage=[],sounds=["bgm.mp3","quack.mp3","ding.mp3","gun.mp3"],playSound=e=>{if(!mute_sfx){storage[sounds.indexOf(e)].cloneNode().play()}},bgm=new Audio("./assets/bgm.mp3"),playBgm=()=>{bgm.loop=!0,bgm.play()},toggleSfx=()=>{mute_sfx=!mute_sfx},toggleBgm=()=>{mute_bgm=!mute_bgm,mute_bgm?bgm.pause():bgm.play()};sounds.forEach(e=>{storage.push(new Audio(`./assets/${e}`))}),mute_sfx_btn.addEventListener("click",toggleSfx),mute_bgm_btn.addEventListener("click",toggleBgm),free_controls&&free_controls.addEventListener("click",()=>{freeMove=!freeMove,free_controls.innerText=freeMove?"Normal Movement":"Free Movement"});const allBtns=docQA("button");allBtns.forEach(e=>{e.addEventListener("focus",()=>{e.blur()})});const allModals=docQA(".modal");function toggleModal(e){"close"!=e?(keyPause=!0,modal_close.hidden=!1,modal_wrap.hidden=!1,allModals.forEach(t=>{t!=docQ(e)?t.hidden=!0:t.hidden=!1})):(keyPause=!1,modal_wrap.hidden=!0,allModals.forEach(e=>{e.hidden=!0}))}allModals.forEach(e=>{e.addEventListener("click",e=>{e.stopPropagation()})}),modal_close.addEventListener("click",()=>{toggleModal("close")}),cheats_btn.addEventListener("click",()=>{toggleModal("#modal_cheats")}),intro_btn.addEventListener("click",()=>{toggleModal("#modal_intro")}),bulletSpeed_input.addEventListener("input",()=>{bulletSpeed_input.parentElement.querySelector('label[for="bulletSpeed"]').innerText=bulletSpeed_input.value+" m/s",bulletSpeed=bulletSpeed_input.value}),bulletSpeed_input.parentElement.querySelector('label[for="bulletSpeed"]').innerText=bulletSpeed+" m/s",reloadSpeed_input.addEventListener("input",()=>{reloadSpeed_input.parentElement.querySelector('label[for="reloadSpeed"]').innerText=reloadSpeed_input.value+" ms",reloadSpeed=reloadSpeed_input.value}),reloadSpeed_input.parentElement.querySelector('label[for="reloadSpeed"]').innerText=reloadSpeed+" ms",rowSpeed_input.addEventListener("input",()=>{rowSpeed_input.parentElement.querySelector('label[for="rowSpeed"]').innerText=rowSpeed_input.value+" m/s",rowSpeed=rowSpeed_input.value}),rowSpeed_input.parentElement.querySelector('label[for="rowSpeed"]').innerText=rowSpeed+" m/s",moveSpeed_input.addEventListener("input",()=>{moveSpeed_input.parentElement.querySelector('label[for="moveSpeed"]').innerText=moveSpeed_input.value+" m/s",moveSpeed=moveSpeed_input.value}),moveSpeed_input.parentElement.querySelector('label[for="moveSpeed"]').innerText=moveSpeed+" m/s";