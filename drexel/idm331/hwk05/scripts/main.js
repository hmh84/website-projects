import*as THREE from"../../scripts/ThreeJS.js";import{OBJLoader}from"../../scripts/OBJLoader.js";const docQ=document.querySelector.bind(document),docQA=document.querySelectorAll.bind(document),vw=Math.max(document.documentElement.clientWidth||0,window.innerWidth||0),vh=Math.max(document.documentElement.clientHeight||0,window.innerHeight||0),canvas=document.getElementById("canvas"),modal_wrap=docQ("#modal_wrap"),start_btn=docQ("#start_btn"),mute_btn=docQ("#mute_btn"),free_controls=docQ("#free_controls"),modal_close=docQ("#modal_close"),bulletSpeed_input=docQ("#bulletSpeed"),reloadSpeed_input=docQ("#reloadSpeed"),rowSpeed_input=docQ("#rowSpeed"),cheats_btn=docQ("#cheats_btn"),keyboard=new THREEx.KeyboardState,scene=new THREE.Scene;scene.background=new THREE.Color(38399);const ambLight=new THREE.AmbientLight(1052688,50);scene.add(ambLight);const camera=new THREE.PerspectiveCamera(45,vw/vh,1,1e3);camera.position.set(0,0,50),camera.rotation.set(0,0,0);const renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0});renderer.setSize(vw,vh),canvas.appendChild(renderer.domElement),renderer.setClearColor(0,0);const newWall=e=>{const t=new THREE.MeshBasicMaterial({color:Number("0x"+e.color),side:THREE.DoubleSide}),o=new THREE.PlaneGeometry(e.width,e.height,1,1),n=new THREE.Mesh(o,t);return n.position.set(e.px||0,e.py||0,e.pz||0),n.rotation.set(e.tx||0,e.ty||0,e.tz||0),n.receiveShadow=!0,scene.add(n),n};let walls=[];const wallCount=9,wallWidth=15,wallHeight=80;for(let e=0;e<9;e++){let t,o;o=0==e?-60:walls[e-1].position.x+15,t=e%2==0?"d84b4b":"ffffff",walls.push(newWall({color:t,width:15,height:80,px:o,pz:-150}))}function newRect(e){const t=new THREE.BoxGeometry(e.width||5,e.height||5,e.depth||10),o=new THREE.MeshBasicMaterial({color:Number("0x"+e.color)||7818498}),n=new THREE.Mesh(t,o);return n.castShadow=!0,n.receiveShadow=!0,n.position.set(e.px||0,e.py||0,e.pz||0),n.rotation.set(e.rx||0,e.ry||0,e.rz||0),scene.add(n),n}const topShelf=newRect({width:135,py:80/6,pz:-145}),btmShelf=newRect({width:135,py:-80/6,pz:-145}),topFrame=newRect({width:135,py:37.5,pz:-145}),btmFrame=newRect({width:135,py:-37.5,pz:-145}),leftFrame=newRect({width:80,px:-65,py:0,pz:-145,rz:Math.PI/2}),rightFrame=newRect({width:80,px:65,py:0,pz:-145,rz:Math.PI/2});let loaderCount=0;function setObjColor(e,t){e.traverse(function(e){e instanceof THREE.Mesh&&e.material.color.setHex(t)})}function getBounds(e){if("Mesh"==e.type){if("SphereGeometry"==e.geometry.type){const t=e.geometry.parameters,o=e.position,n=Number(t.radius.toFixed(2)),r=2*n||null;return{height:r,width:r,depth:r,x:o.x-n,y:o.y-n,z:o.z-n,radius:n}}}else if("Group"==e.type){const t=(new THREE.Box3).setFromObject(e),o=new THREE.Vector3;t.getSize(o);const n=e.position;return{height:o.y,width:o.x,depth:o.z,x:n.x-o.x/2,y:n.y,z:n.z}}}const topShelfHeight=topShelf.position.y+2.5,btmShelfHeight=2.5-topShelf.position.y;let duck,duck2;const loaderObj=new OBJLoader;let target,bullet;function defaultTargetColor(){setObjColor(target.children[0],16711680),setObjColor(target.children[1],16711680),setObjColor(target.children[2],16777215),setObjColor(target.children[3],16711680)}loaderObj.load("./assets/duckie.obj",e=>{duck=e,setObjColor(duck,16776960);duck.scale.set(4,4,4),duck.position.x=15,duck.position.y=btmShelfHeight,duck.position.z=-145,scene.add(duck)},e=>{const t=Math.round(e.loaded/e.total*100);t>=100?readySet():console.log("Progress: "+t)},e=>{console.error("loaderObj ERROR: ",e)}),loaderObj.load("./assets/target.obj",e=>{target=e,defaultTargetColor();e.scale.set(6,6,6),e.position.x=-10,e.position.y=btmShelfHeight,e.position.z=-145,scene.add(e)},e=>{const t=Math.round(e.loaded/e.total*100);t>=100?readySet():console.log("Progress: "+t)},e=>{console.error("loaderObj ERROR: ",e)}),(async()=>{const e=new THREE.SphereGeometry(.5,32,32),t=new THREE.MeshBasicMaterial({color:0});bullet=new THREE.Mesh(e,t),bullet.position.z=-1e3,scene.add(bullet)})();let gunPause=!1,reloadSpeed=750;function shootGun(){gunPause||(gunPause=!0,bullet.position.x=camera.position.x,bullet.position.y=camera.position.y,bullet.position.z=camera.position.z,playSound("gun.mp3"),setTimeout(()=>{gunPause=!1},reloadSpeed))}function readySet(){loaderCount++,2==loaderCount&&(start_btn.innerText="Start",start_btn.disabled=!1,start_btn.addEventListener("click",()=>{modal_wrap.style.backgroundColor="#00000070",toggleModal("close"),modal_wrap.addEventListener("click",()=>{toggleModal("close")}),animate(),playBgm()}))}let keyPause=!1;const animate=()=>{requestAnimationFrame(animate),detectCollision(),moveObjects(),!keyPause&&keyboardListener(),renderer.render(scene,camera)};function keyboardListener(){const e=camera.position,t=camera.rotation,o=.25,n=e=>keyboard.pressed(e);n("space")&&shootGun(),devMode?(n("w")&&(e.y+=.5),n("s")&&(e.y-=.5),n("a")&&(e.x-=.5),n("d")&&(e.x+=.5),n("up")&&(e.z-=.5),n("down")&&(e.z+=.5),n("left")&&(e.x-=.5),n("right")&&(e.x+=.5),n("a")&&(t.y+=.025),n("d")&&(t.y-=.025)):(n("w")&&(e.y+=o),n("s")&&(e.y-=o),n("a")&&(e.x-=o),n("d")&&(e.x+=o))}window.devMode=!1;let bulletSpeed=10,rowSpeed=.9;function moveObjects(){bullet.position.z>-1e3&&(bullet.position.z-=bulletSpeed),duck.position.x>-72.5?duck.position.x-=rowSpeed:duck.position.x=72.5,target.position.x>-72.5?target.position.x-=rowSpeed:target.position.x=72.5}function detectCollision(){const e=getBounds(bullet),t=getBounds(duck);t.x<e.x+e.width&&t.x+t.width>e.x&&t.y<e.y+e.height&&t.y+t.height>e.y&&t.z<e.z+e.width&&t.z+t.width>e.z&&t.x<e.x+e.height&&t.x+t.height>e.x&&t.z<e.z+e.width&&t.z+t.width>e.z&&t.y<e.y+e.height&&t.y+t.height>e.y?(updateScore(-1,"quack.mp3"),setObjColor(duck,16711680)):setObjColor(duck,16776960);const o=getBounds(target);e.x<o.x+o.width&&e.x+e.width>o.x&&e.y<o.y+o.height&&e.y+e.height>o.y&&e.z<o.z+o.width&&e.z+e.width>o.z&&e.x<o.x+o.height&&e.x+e.height>o.x&&e.z<o.z+o.width&&t.z+e.width>o.z&&e.y<o.y+o.height&&e.y+e.height>o.y?(updateScore(1,"ding.mp3"),setObjColor(target,16777215)):defaultTargetColor()}let score=0;docQ("#score").innerText="Score: "+score;let scorePause=!1;const updateScore=(e,t)=>{scorePause||(t&&playSound(t),scorePause=!0,score+=100*e,docQ("#score").innerText="Score: "+score,setTimeout(()=>{scorePause=!1},reloadSpeed-100))};let mute=!1;const storage=[],sounds=["bgm.mp3","quack.mp3","ding.mp3","gun.mp3"],playSound=e=>{if(!mute){storage[sounds.indexOf(e)].cloneNode().play()}},bgm=new Audio("./assets/bgm.mp3"),playBgm=()=>{bgm.play()},toggleMute=()=>{mute=!mute,mute?(mute_btn.innerText="Unmute",bgm.pause()):(mute_btn.innerText="Mute",bgm.play())};sounds.forEach(e=>{storage.push(new Audio(`./assets/${e}`))}),mute_btn.addEventListener("click",toggleMute),free_controls&&free_controls.addEventListener("click",()=>{devMode=!devMode,devMode?free_controls.innerText="Normal Movement":free_controls.innerText="Free Movement"});const allBtns=docQA("button");allBtns.forEach(e=>{e.addEventListener("focus",()=>{e.blur()})});const allModals=docQA(".modal");function toggleModal(e){"close"!=e?(keyPause=!0,modal_close.hidden=!1,modal_wrap.hidden=!1,allModals.forEach(t=>{t!=docQ(e)?t.hidden=!0:t.hidden=!1})):(keyPause=!1,modal_wrap.hidden=!0,allModals.forEach(e=>{e.hidden=!0}))}allModals.forEach(e=>{e.addEventListener("click",e=>{e.stopPropagation()})}),modal_close.addEventListener("click",()=>{toggleModal("close")}),cheats_btn.addEventListener("click",()=>{toggleModal("#modal_cheats")}),bulletSpeed_input.addEventListener("input",()=>{bulletSpeed_input.parentElement.querySelector('label[for="bulletSpeed"]').innerText=bulletSpeed_input.value+" m/s",bulletSpeed=bulletSpeed_input.value}),bulletSpeed_input.parentElement.querySelector('label[for="bulletSpeed"]').innerText=bulletSpeed+" m/s",reloadSpeed_input.addEventListener("input",()=>{reloadSpeed_input.parentElement.querySelector('label[for="reloadSpeed"]').innerText=reloadSpeed_input.value+" ms",reloadSpeed=reloadSpeed_input.value}),reloadSpeed_input.parentElement.querySelector('label[for="reloadSpeed"]').innerText=reloadSpeed+" ms",rowSpeed_input.addEventListener("input",()=>{rowSpeed_input.parentElement.querySelector('label[for="rowSpeed"]').innerText=rowSpeed_input.value+" m/s",rowSpeed=rowSpeed_input.value}),rowSpeed_input.parentElement.querySelector('label[for="rowSpeed"]').innerText=rowSpeed+" m/s";